#!/bin/bash

# Cycles through the background images available

BACKGROUNDS_DIR="$HOME/.config/omarchy/current/theme/backgrounds/"
CURRENT_BACKGROUND_LINK="$HOME/.config/omarchy/current/background"

mapfile -d '' -t BACKGROUNDS < <(find -L "$BACKGROUNDS_DIR" -type f -print0 | sort -z)
TOTAL=${#BACKGROUNDS[@]}

#printing for debug
echo "== Available BACKGROUNDS =="
printf '%s\n' "${BACKGROUNDS[@]}"

if [[ -L "$CURRENT_BACKGROUND_LINK" ]]; then
    CURRENT_BACKGROUND=$(readlink -f "$CURRENT_BACKGROUND_LINK")
    echo "== Current background link points to =="
    echo "$CURRENT_BACKGROUND"
else
    echo "== Current background link not found =="
fi

## Continue indexing
if [[ $TOTAL -eq 0 ]]; then
  notify-send "No background was found for theme" -t 2000
  pkill -x swaybg
  pkill -x mpvpaper
  setsid uwsm app -- swaybg --color '#000000' >/dev/null 2>&1 &
else
  # Get current background from symlink
  if [[ -L "$CURRENT_BACKGROUND_LINK" ]]; then
    CURRENT_BACKGROUND=$(readlink "$CURRENT_BACKGROUND_LINK")
  else
    # Default to first background if no symlink exists
    CURRENT_BACKGROUND=""
  fi

  # Find current background index
  INDEX=-1
  for i in "${!BACKGROUNDS[@]}"; do
    if [[ "${BACKGROUNDS[$i]}" == "$CURRENT_BACKGROUND" ]]; then
      INDEX=$i
      break
    fi
  done

  # Get next background (wrap around)
  if [[ $INDEX -eq -1 ]]; then
    # Use the first background when no match was found
    NEW_BACKGROUND="${BACKGROUNDS[0]}"
  else
    NEXT_INDEX=$(((INDEX + 1) % TOTAL))
    NEW_BACKGROUND="${BACKGROUNDS[$NEXT_INDEX]}"
  fi

  # Check chosen background printing for debug
    echo "== Calculated INDEX =="
    echo "$INDEX"
    echo "== NEW_BACKGROUND will be =="
    echo "$NEW_BACKGROUND"


  # Set new background symlink
   ln -nsf "$NEW_BACKGROUND" "$CURRENT_BACKGROUND_LINK"
  # Attempting manual replacement for /.config/omarchy/current/background file rather than symlink
    #rm -f "$CURRENT_BACKGROUND_LINK""
    #cp "$NEW_BACKGROUND" "$CURRENT_BACKGROUND_LINK"

  # Relaunch wallpaper
  pkill -x swaybg
  pkill -x mpvpaper

  case "${NEW_BACKGROUND##*.}" in
    png|jpg|jpeg|bmp|webp|avif)
  setsid uwsm app -- swaybg -i "$CURRENT_BACKGROUND_LINK" -m fill >/dev/null 2>&1 &
  ;;
    mp4|webm|gif|mkv)
  setsid uwsm app -- mpvpaper -o "--loop --no-audio --panscan=1.0 --hwdec=gpu" '*' "$CURRENT_BACKGROUND_LINK" &
  ;;
esac
fi
